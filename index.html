<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b0f19; color: #e8eefc; display: grid; place-items: center; min-height: 100vh; }
    .card { width: min(520px, 92vw); background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 14px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .wheel-wrap { position: relative; display: grid; place-items: center; gap: 10px; margin-top: 12px; }
    canvas { background: transparent; }
    #swordPointer {
      position: absolute;
      top: -12px;
      left: 50%;
      width: 88px;
      transform: translateX(-50%) rotate(0deg);
      transform-origin: 50% 18%;
      z-index: 3;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.45));
      pointer-events: none;
    }
    #swordPointer svg { width: 100%; height: auto; display: block; }
    button {
      appearance: none; border: 0; cursor: pointer;
      background: #3b82f6; color: white; font-weight: 700;
      padding: 12px 14px; border-radius: 12px;
      box-shadow: 0 10px 20px rgba(59,130,246,.25);
      transition: transform .05s ease;
      width: 100%;
    }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .small { opacity: .8; font-size: 13px; line-height: 1.35; }
    .result { margin-top: 10px; font-size: 16px; font-weight: 700; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); }
    .grid { display:grid; gap: 10px; }
    .inputs { display:flex; gap: 10px; flex-wrap: wrap; }
    input {
      flex: 1 1 160px;
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25); color: #e8eefc;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <h1>üé° –ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</h1>
      <span class="pill" id="status">–ì–æ—Ç–æ–≤–æ</span>
    </div>

    <div class="small">
      –í–≤–µ–¥–∏ –ø—Ä–∏–∑—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏ –∂–º–∏ ¬´–ö—Ä—É—Ç–∏—Ç—å¬ª.
    </div>

    <div class="inputs" style="margin-top: 12px;">
      <input id="itemsInput" value="100‚≠ê, 50‚≠ê, 10‚≠ê, –ù–∏—á–µ–≥–æ, –°–∫–∏–¥–∫–∞ 10%, –°–∫–∏–¥–∫–∞ 30%, –°—é—Ä–ø—Ä–∏–∑" />
      <input id="seedInput" placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–∏–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä 123" />
    </div>

    <div class="wheel-wrap">
      <div id="swordPointer" aria-hidden="true">
        <svg viewBox="0 0 120 240" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <linearGradient id="bladeGrad" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0" stop-color="#f7f3e8"/>
              <stop offset="0.45" stop-color="#cfd6e0"/>
              <stop offset="1" stop-color="#9aa4b2"/>
            </linearGradient>
            <linearGradient id="hiltGrad" x1="0" x2="1" y1="0" y2="0">
              <stop offset="0" stop-color="#c7a56b"/>
              <stop offset="0.5" stop-color="#e6c88a"/>
              <stop offset="1" stop-color="#8f6a32"/>
            </linearGradient>
          </defs>
          <rect x="52" y="24" width="16" height="150" rx="6" fill="url(#bladeGrad)" stroke="#707785" stroke-width="2"/>
          <rect x="49" y="16" width="22" height="14" rx="6" fill="#a9b2c2"/>
          <rect x="28" y="165" width="64" height="16" rx="8" fill="url(#hiltGrad)" stroke="#6a4a21" stroke-width="2"/>
          <rect x="52" y="180" width="16" height="28" rx="6" fill="#5d3a1c"/>
          <circle cx="60" cy="214" r="10" fill="url(#hiltGrad)" stroke="#6a4a21" stroke-width="2"/>
          <circle cx="60" cy="214" r="4" fill="#3a240f"/>
        </svg>
      </div>
      <canvas id="wheel" width="360" height="360"></canvas>
    </div>

    <div class="grid">
      <button id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å</button>
      <div class="result" id="result">–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚Äî</div>
      <div class="small" id="debug"></div>
    </div>
  </div>

  <script>
  const tg = window.Telegram?.WebApp;
    // ====== Sound (Web Audio) ======
let audioCtx = null;
let soundEnabled = true;
let lastTickStep = null;

function ensureAudio() {
  if (!soundEnabled) return null;
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}

function playTick() {
  try {
    const ac = ensureAudio();
    if (!ac) return;

    const o = ac.createOscillator();
    const g = ac.createGain();

    o.type = "square";
    o.frequency.value = 1400;

    const now = ac.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.08, now + 0.003);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.035);

    o.connect(g);
    g.connect(ac.destination);
    o.start(now);
    o.stop(now + 0.04);
  } catch (error) {
    console.warn("Tick sound failed:", error);
  }
}

function playWin() {
  try {
    const ac = ensureAudio();
    if (!ac) return;

    const o = ac.createOscillator();
    const g = ac.createGain();

    o.type = "sine";

    const now = ac.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.25);

    o.frequency.setValueAtTime(880, now);
    o.frequency.setValueAtTime(1320, now + 0.08);
    o.frequency.setValueAtTime(990, now + 0.16);

    o.connect(g);
    g.connect(ac.destination);
    o.start(now);
    o.stop(now + 0.28);
  } catch (error) {
    console.warn("Win sound failed:", error);
  }
}

  if (tg) {
    tg.ready();
    tg.expand();
    tg.MainButton.hide();
}

    // ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ======
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");

    const spinBtn = document.getElementById("spinBtn");
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");
    const swordPointer = document.getElementById("swordPointer");

    const itemsInput = document.getElementById("itemsInput");
    const seedInput = document.getElementById("seedInput");

    let items = parseItems(itemsInput.value);
    let angle = 0;          // —Ç–µ–∫—É—â–∏–π —É–≥–æ–ª –≤—Ä–∞—â–µ–Ω–∏—è
    let spinning = false;
    let swordTicking = false;

    // –í–∏–∑—É–∞–ª
    const size = canvas.width;
    const cx = size / 2;
    const cy = size / 2;
    const r = size / 2 - 8;

    function swordTick(strength = 1) {
      if (!swordPointer || swordTicking) return;
      swordTicking = true;
      const clamped = Math.min(1.4, Math.max(0.6, strength));
      const maxTilt = -18 * clamped;
      const base = "translateX(-50%) rotate(0deg)";
      const kick = `translateX(-50%) rotate(${maxTilt}deg)`;

      if (typeof swordPointer.animate !== "function") {
        swordPointer.style.transform = kick;
        setTimeout(() => {
          swordPointer.style.transform = base;
          swordTicking = false;
        }, 200);
        return;
      }

      const animation = swordPointer.animate(
        [{ transform: base }, { transform: kick }, { transform: base }],
        { duration: 240, easing: "cubic-bezier(0.25, 0.6, 0.2, 1.4)" }
      );
      animation.onfinish = () => { swordTicking = false; };
      animation.oncancel = () => { swordTicking = false; };
    }

    // ====== –†–µ–Ω–¥–µ—Ä –∫–æ–ª–µ—Å–∞ ======
    function drawWheel() {
      ctx.clearRect(0, 0, size, size);

      const n = items.length;
      const slice = (Math.PI * 2) / n;
      const innerRadius = r * 0.22;

      for (let i = 0; i < n; i++) {
        const start = angle + i * slice;
        const end = start + slice;
        const mid = start + slice / 2;
        const isEven = i % 2 === 0;
        const baseLight = isEven ? "#d5a16b" : "#c48b55";
        const baseMid = isEven ? "#b57a44" : "#a26c3a";
        const baseDark = isEven ? "#8a582d" : "#7a4c24";

        const grad = ctx.createLinearGradient(
          cx + Math.cos(mid) * r * 0.1,
          cy + Math.sin(mid) * r * 0.1,
          cx + Math.cos(mid) * r,
          cy + Math.sin(mid) * r
        );
        grad.addColorStop(0, baseLight);
        grad.addColorStop(0.5, baseMid);
        grad.addColorStop(1, baseDark);

        // —Ü–≤–µ—Ç —Å–µ–∫—Ç–æ—Ä–∞
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, end);
        ctx.closePath();
        ctx.fillStyle = grad;
        ctx.fill();

        // —Ç–µ–∫—Å—Ç—É—Ä–∞ –¥–µ—Ä–µ–≤–∞
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,.12)";
        ctx.lineWidth = 1;
        for (let ring = 0; ring < 3; ring++) {
          const ringRadius = r - 16 - ring * 14;
          ctx.beginPath();
          ctx.arc(cx, cy, ringRadius, start, end);
          ctx.stroke();
        }
        ctx.restore();

        // —Ç–µ–∫—Å—Ç
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(start + slice / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#f7efe2";
        ctx.shadowColor = "rgba(0,0,0,0.45)";
        ctx.shadowBlur = 4;
        ctx.font = "bold 15px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(items[i], r - 14, 6);
        ctx.restore();
      }

      // –±—Ä–æ–Ω–∑–æ–≤—ã–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
      ctx.save();
      ctx.strokeStyle = "#b07a34";
      ctx.lineWidth = 3;
      for (let i = 0; i < n; i++) {
        const lineAngle = angle + i * slice;
        ctx.beginPath();
        ctx.moveTo(cx + Math.cos(lineAngle) * innerRadius, cy + Math.sin(lineAngle) * innerRadius);
        ctx.lineTo(cx + Math.cos(lineAngle) * r, cy + Math.sin(lineAngle) * r);
        ctx.stroke();
      }
      ctx.restore();

      // –±—Ä–æ–Ω–∑–æ–≤–∞—è –æ–∫–∞–Ω—Ç–æ–≤–∫–∞
      const rimGradient = ctx.createRadialGradient(cx, cy, r * 0.72, cx, cy, r + 8);
      rimGradient.addColorStop(0, "#8b5a2c");
      rimGradient.addColorStop(0.5, "#c89a52");
      rimGradient.addColorStop(1, "#5a3b1c");
      ctx.beginPath();
      ctx.arc(cx, cy, r + 3, 0, Math.PI * 2);
      ctx.strokeStyle = rimGradient;
      ctx.lineWidth = 12;
      ctx.stroke();

      // –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∫–æ–ª—å—Ü–æ
      const innerGradient = ctx.createRadialGradient(cx, cy, innerRadius * 0.3, cx, cy, innerRadius);
      innerGradient.addColorStop(0, "#d4b07a");
      innerGradient.addColorStop(1, "#8b5a2c");
      ctx.beginPath();
      ctx.arc(cx, cy, innerRadius, 0, Math.PI * 2);
      ctx.strokeStyle = innerGradient;
      ctx.lineWidth = 6;
      ctx.stroke();

      // —Ü–µ–Ω—Ç—Ä
      ctx.beginPath();
      ctx.arc(cx, cy, 24, 0, Math.PI * 2);
      ctx.fillStyle = "#f2e6cf";
      ctx.fill();
      ctx.strokeStyle = "#6b4a23";
      ctx.lineWidth = 3;
      ctx.stroke();
    }

    // ====== –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ (–∫—É–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–µ–ª–∫–∞ —Å–≤–µ—Ä—Ö—É) ======
    function pickIndex() {
      const n = items.length;
      const slice = (Math.PI * 2) / n;

      // –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–≤–µ—Ä—Ö—É (—É–≥–æ–ª -90¬∞), –Ω–æ –≤ canvas 0 —Ä–∞–¥ —Å–ø—Ä–∞–≤–∞.
      // –ü–æ—ç—Ç–æ–º—É —Å–¥–≤–∏–≥–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã "–≤–µ—Ä—Ö" –±—ã–ª —Ç–æ—á–∫–æ–π –≤—ã–±–æ—Ä–∞:
      const pointerAngle = -Math.PI / 2;

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª: –∫–∞–∫–æ–π —Å–µ–∫—Ç–æ—Ä —Å–µ–π—á–∞—Å –ø–æ–¥ —Å—Ç—Ä–µ–ª–∫–æ–π
      let a = (pointerAngle - angle) % (Math.PI * 2);
      if (a < 0) a += Math.PI * 2;

      const idx = Math.floor(a / slice);
      return idx;
    }

    // ====== –ü—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π RNG (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã) ======
    function mulberry32(seed) {
      let t = seed >>> 0;
      return function() {
        t += 0x6D2B79F5;
        let x = Math.imul(t ^ (t >>> 15), 1 | t);
        x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
        return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
      };
    }

    function parseItems(text) {
      const arr = text.split(",").map(s => s.trim()).filter(Boolean);
      return arr.length ? arr : ["–ü—Ä–∏–∑ 1", "–ü—Ä–∏–∑ 2", "–ü—Ä–∏–∑ 3"];
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    // ====== –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è ======
    function spin() {
      if (spinning) return;

      items = parseItems(itemsInput.value);
      drawWheel();

      spinning = true;
      lastTickStep = null;


      if (tg) tg.MainButton.hide();

      spinBtn.disabled = true;
      setStatus("–ö—Ä—É—Ç–∏–º‚Ä¶");

      // RNG: –ª–∏–±–æ —Å–∏–¥, –ª–∏–±–æ –æ–±—ã—á–Ω—ã–π Math.random
      const seedVal = seedInput.value.trim();
      const rnd = seedVal ? mulberry32(Number(seedVal) || 123) : Math.random;

      // –•–æ—Ç–∏–º 4..7 –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ + –¥–æ–∫—Ä—É—Ç–∫–∞
      const extraTurns = 4 + Math.floor((seedVal ? rnd() : Math.random()) * 4);
      const target = angle + extraTurns * Math.PI * 2 + (seedVal ? rnd() : Math.random()) * Math.PI * 2;

      const start = angle;
      const delta = target - start;

      const duration = 2600; // –º—Å
      const t0 = performance.now();

      function easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
      }

      function frame(now) {
        const t = Math.min(1, (now - t0) / duration);
        const eased = easeOutCubic(t);
        angle = start + delta * eased;
        const n = items.length;
const step = (Math.PI * 2) / (n * 2);
const tickStep = Math.floor(angle / step);

if (tickStep !== lastTickStep) {
  lastTickStep = tickStep;
  playTick();
  swordTick();
      }


        drawWheel();

        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          // –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          angle = angle % (Math.PI * 2);
          const idx = pickIndex();
          const prize = items[idx];

          resultEl.textContent = "–†–µ–∑—É–ª—å—Ç–∞—Ç: " + prize;
          playWin();


if (tg) {
  tg.MainButton.setText("–ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑");
  tg.MainButton.show();

  // —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª—Å—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—Ä–∞—â–µ–Ω–∏—è—Ö
  tg.MainButton.offClick?.();

  tg.MainButton.onClick(() => {
    tg.sendData(JSON.stringify({ prize, idx, items }));
    // tg.close(); // –≤–∫–ª—é—á–∏—à—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –∑–∞–∫—Ä—ã–≤–∞—Ç—å –æ–∫–Ω–æ
  });
}

debugEl.textContent = `–°–µ–∫—Ç–æ—Ä #${idx + 1} –∏–∑ ${items.length}`;


          setStatus("–ì–æ—Ç–æ–≤–æ");
          spinning = false;
          spinBtn.disabled = false;
        }
      }

      requestAnimationFrame(frame);
    }

    // ====== –°–æ–±—ã—Ç–∏—è ======
    spinBtn.addEventListener("click", () => {
  ensureAudio();
  spin();
    });

    itemsInput.addEventListener("change", () => {
      items = parseItems(itemsInput.value);
      drawWheel();
    });

    // –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
    drawWheel();
  </script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

</body>
</html>


