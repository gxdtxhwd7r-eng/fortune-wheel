<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background: #0b0f19; color: #e8eefc; display: grid; place-items: center; min-height: 100vh; }
    .card { width: min(520px, 92vw); background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .row { display: flex; gap: 14px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .wheel-wrap { display: grid; place-items: center; gap: 10px; margin-top: 12px; }
    canvas { background: transparent; }
    .pointer {
      width: 0; height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-top: 22px solid #ffd54a;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.4));
      margin-top: -6px;
    }
    button {
      appearance: none; border: 0; cursor: pointer;
      background: #3b82f6; color: white; font-weight: 700;
      padding: 12px 14px; border-radius: 12px;
      box-shadow: 0 10px 20px rgba(59,130,246,.25);
      transition: transform .05s ease;
      width: 100%;
    }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .small { opacity: .8; font-size: 13px; line-height: 1.35; }
    .result { margin-top: 10px; font-size: 16px; font-weight: 700; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); }
    .grid { display:grid; gap: 10px; }
    .inputs { display:flex; gap: 10px; flex-wrap: wrap; }
    input {
      flex: 1 1 160px;
      padding: 10px 12px; border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25); color: #e8eefc;
      outline: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <h1>üé° –ö–æ–ª–µ—Å–æ —Ñ–æ—Ä—Ç—É–Ω—ã</h1>
      <span class="pill" id="status">–ì–æ—Ç–æ–≤–æ</span>
    </div>

    <div class="small">
      –í–≤–µ–¥–∏ –ø—Ä–∏–∑—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏ –∂–º–∏ ¬´–ö—Ä—É—Ç–∏—Ç—å¬ª.
    </div>

    <div class="inputs" style="margin-top: 12px;">
      <input id="itemsInput" value="100‚≠ê, 50‚≠ê, 10‚≠ê, –ù–∏—á–µ–≥–æ, –°–∫–∏–¥–∫–∞ 10%, –°–∫–∏–¥–∫–∞ 30%, –°—é—Ä–ø—Ä–∏–∑" />
      <input id="seedInput" placeholder="(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–∏–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä 123" />
    </div>

    <div class="wheel-wrap">
      <div class="pointer"></div>
      <canvas id="wheel" width="360" height="360"></canvas>
    </div>

    <div class="grid">
      <button id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å</button>
      <div class="result" id="result">–†–µ–∑—É–ª—å—Ç–∞—Ç: ‚Äî</div>
      <div class="small" id="debug"></div>
    </div>
  </div>

  <script>
  const tg = window.Telegram?.WebApp;
    // ====== Sound (Web Audio) ======
let audioCtx = null;
let soundEnabled = true;
let lastTickStep = null;

function ensureAudio() {
  if (!soundEnabled) return null;
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (audioCtx.state === "suspended") audioCtx.resume();
  return audioCtx;
}

function playTick() {
  try {
    const ac = ensureAudio();
    if (!ac) return;

    const o = ac.createOscillator();
    const g = ac.createGain();

    o.type = "square";
    o.frequency.value = 1400;

    const now = ac.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.08, now + 0.003);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.035);

    o.connect(g);
    g.connect(ac.destination);
    o.start(now);
    o.stop(now + 0.04);
  } catch (error) {
    console.warn("Tick sound failed:", error);
  }
}

function playWin() {
  try {
    const ac = ensureAudio();
    if (!ac) return;

    const o = ac.createOscillator();
    const g = ac.createGain();

    o.type = "sine";

    const now = ac.currentTime;
    g.gain.setValueAtTime(0.0001, now);
    g.gain.exponentialRampToValueAtTime(0.12, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, now + 0.25);

    o.frequency.setValueAtTime(880, now);
    o.frequency.setValueAtTime(1320, now + 0.08);
    o.frequency.setValueAtTime(990, now + 0.16);

    o.connect(g);
    g.connect(ac.destination);
    o.start(now);
    o.stop(now + 0.28);
  } catch (error) {
    console.warn("Win sound failed:", error);
  }
}

  if (tg) {
    tg.ready();
    tg.expand();
    tg.MainButton.hide();
}

    // ====== –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ======
    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");

    const spinBtn = document.getElementById("spinBtn");
    const resultEl = document.getElementById("result");
    const statusEl = document.getElementById("status");
    const debugEl = document.getElementById("debug");

    const itemsInput = document.getElementById("itemsInput");
    const seedInput = document.getElementById("seedInput");

    let items = parseItems(itemsInput.value);
    let angle = 0;          // —Ç–µ–∫—É—â–∏–π —É–≥–æ–ª –≤—Ä–∞—â–µ–Ω–∏—è
    let spinning = false;

    // –í–∏–∑—É–∞–ª
    const size = canvas.width;
    const cx = size / 2;
    const cy = size / 2;
    const r = size / 2 - 8;

    // ====== –†–µ–Ω–¥–µ—Ä –∫–æ–ª–µ—Å–∞ ======
    function drawWheel() {
      ctx.clearRect(0, 0, size, size);

      const n = items.length;
      const slice = (Math.PI * 2) / n;

      for (let i = 0; i < n; i++) {
        const start = angle + i * slice;
        const end = start + slice;

        // —Ü–≤–µ—Ç —Å–µ–∫—Ç–æ—Ä–∞
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, end);
        ctx.closePath();
        ctx.fillStyle = i % 2 === 0 ? "rgba(59,130,246,.85)" : "rgba(147,197,253,.85)";
        ctx.fill();

        // –≥—Ä–∞–Ω–∏—Ü—ã
        ctx.strokeStyle = "rgba(255,255,255,.18)";
        ctx.lineWidth = 2;
        ctx.stroke();

        // —Ç–µ–∫—Å—Ç
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(start + slice / 2);
        ctx.textAlign = "right";
        ctx.fillStyle = "#0b0f19";
        ctx.font = "bold 15px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(items[i], r - 14, 6);
        ctx.restore();
      }

      // —Ü–µ–Ω—Ç—Ä
      ctx.beginPath();
      ctx.arc(cx, cy, 28, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(255,255,255,.9)";
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,.25)";
      ctx.stroke();
    }

    // ====== –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–µ–∫—Ç–æ—Ä–∞ (–∫—É–¥–∞ —É–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–µ–ª–∫–∞ —Å–≤–µ—Ä—Ö—É) ======
    function pickIndex() {
      const n = items.length;
      const slice = (Math.PI * 2) / n;

      // –°—Ç—Ä–µ–ª–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Å–≤–µ—Ä—Ö—É (—É–≥–æ–ª -90¬∞), –Ω–æ –≤ canvas 0 —Ä–∞–¥ —Å–ø—Ä–∞–≤–∞.
      // –ü–æ—ç—Ç–æ–º—É —Å–¥–≤–∏–≥–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã "–≤–µ—Ä—Ö" –±—ã–ª —Ç–æ—á–∫–æ–π –≤—ã–±–æ—Ä–∞:
      const pointerAngle = -Math.PI / 2;

      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —É–≥–æ–ª: –∫–∞–∫–æ–π —Å–µ–∫—Ç–æ—Ä —Å–µ–π—á–∞—Å –ø–æ–¥ —Å—Ç—Ä–µ–ª–∫–æ–π
      let a = (pointerAngle - angle) % (Math.PI * 2);
      if (a < 0) a += Math.PI * 2;

      const idx = Math.floor(a / slice);
      return idx;
    }

    // ====== –ü—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π RNG (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å –ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã) ======
    function mulberry32(seed) {
      let t = seed >>> 0;
      return function() {
        t += 0x6D2B79F5;
        let x = Math.imul(t ^ (t >>> 15), 1 | t);
        x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
        return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
      };
    }

    function parseItems(text) {
      const arr = text.split(",").map(s => s.trim()).filter(Boolean);
      return arr.length ? arr : ["–ü—Ä–∏–∑ 1", "–ü—Ä–∏–∑ 2", "–ü—Ä–∏–∑ 3"];
    }

    function setStatus(text) {
      statusEl.textContent = text;
    }

    // ====== –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è ======
    function spin() {
      if (spinning) return;

      items = parseItems(itemsInput.value);
      drawWheel();

      spinning = true;
      lastTickStep = null;


      if (tg) tg.MainButton.hide();

      spinBtn.disabled = true;
      setStatus("–ö—Ä—É—Ç–∏–º‚Ä¶");

      // RNG: –ª–∏–±–æ —Å–∏–¥, –ª–∏–±–æ –æ–±—ã—á–Ω—ã–π Math.random
      const seedVal = seedInput.value.trim();
      const rnd = seedVal ? mulberry32(Number(seedVal) || 123) : Math.random;

      // –•–æ—Ç–∏–º 4..7 –ø–æ–ª–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ + –¥–æ–∫—Ä—É—Ç–∫–∞
      const extraTurns = 4 + Math.floor((seedVal ? rnd() : Math.random()) * 4);
      const target = angle + extraTurns * Math.PI * 2 + (seedVal ? rnd() : Math.random()) * Math.PI * 2;

      const start = angle;
      const delta = target - start;

      const duration = 2600; // –º—Å
      const t0 = performance.now();

      function easeOutCubic(t) {
        return 1 - Math.pow(1 - t, 3);
      }

      function frame(now) {
        const t = Math.min(1, (now - t0) / duration);
        const eased = easeOutCubic(t);
        angle = start + delta * eased;
        const n = items.length;
const step = (Math.PI * 2) / (n * 2);
const tickStep = Math.floor(angle / step);

if (tickStep !== lastTickStep) {
  lastTickStep = tickStep;
  playTick();
      }


        drawWheel();

        if (t < 1) {
          requestAnimationFrame(frame);
        } else {
          // –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          angle = angle % (Math.PI * 2);
          const idx = pickIndex();
          const prize = items[idx];

          resultEl.textContent = "–†–µ–∑—É–ª—å—Ç–∞—Ç: " + prize;
          playWin();


if (tg) {
  tg.MainButton.setText("–ó–∞–±—Ä–∞—Ç—å –ø—Ä–∏–∑");
  tg.MainButton.show();

  // —á—Ç–æ–±—ã –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–ª—Å—è –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—Ä–∞—â–µ–Ω–∏—è—Ö
  tg.MainButton.offClick?.();

  tg.MainButton.onClick(() => {
    tg.sendData(JSON.stringify({ prize, idx, items }));
    // tg.close(); // –≤–∫–ª—é—á–∏—à—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å –∑–∞–∫—Ä—ã–≤–∞—Ç—å –æ–∫–Ω–æ
  });
}

debugEl.textContent = `–°–µ–∫—Ç–æ—Ä #${idx + 1} –∏–∑ ${items.length}`;


          setStatus("–ì–æ—Ç–æ–≤–æ");
          spinning = false;
          spinBtn.disabled = false;
        }
      }

      requestAnimationFrame(frame);
    }

    // ====== –°–æ–±—ã—Ç–∏—è ======
    spinBtn.addEventListener("click", () => {
  ensureAudio();
  spin();
    });

    itemsInput.addEventListener("change", () => {
      items = parseItems(itemsInput.value);
      drawWheel();
    });

    // –ø–µ—Ä–≤—ã–π —Ä–µ–Ω–¥–µ—Ä
    drawWheel();
  </script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

</body>
</html>


